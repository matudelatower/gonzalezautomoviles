<?php

namespace VehiculosBundle\Entity;

/**
 * VehiculoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class VehiculoRepository extends \Doctrine\ORM\EntityRepository {

    public function getVehiculosEstado($estado, $filters = null, $order = false) {
        $ids = array();
        if ($estado) {
            foreach ($estado as $item) {
                $ids[] = $item->getId();
            }
            $idsEstado = implode(',', $ids);
            $where = "tipo_estado_vehiculo.id in ($idsEstado)";
        } else {
            $where = "0=0";
        }


        $db = $this->getEntityManager()->getConnection();


        if ($filters['vin']) {

            $where.=" AND upper(v.vin) LIKE upper('%" . $filters['vin'] . "%')";
        }
        if ($filters['colorVehiculo']) {
            $where.=" AND v.color_vehiculo_id=" . $filters['colorVehiculo']->getId();
        }
        if ($filters['tipoVentaEspecial']) {
            $where.=" AND v.tipo_venta_especial_id=" . $filters['tipoVentaEspecial']->getId();
        }
        if ($filters['deposito']) {
            $where.=" AND d.id=" . $filters['deposito']->getId();
        }
        if ($filters['modelo']) {
            $where.=" AND nm.id=" . $filters['modelo']->getId();
        }
        if ($filters['cliente']) {
            $where.=" AND v.cliente_id=" . $filters['cliente']->getId();
        }
        if (!$order) {
            $order = " modelo_nombre asc,modelo_anio asc,color_vehiculo asc";
        } 

        $query = "SELECT   distinct(v.*),
                                        cm.codigo as modelo_codigo,cm.anio as modelo_anio,nm.nombre as modelo_nombre,cm.version as modelo_version,
                                        tipo_estado_vehiculo.estado as vehiculo_estado,tipo_estado_vehiculo.slug as vehiculo_estado_slug,remitos.fecha as remito_fecha,
                                        remitos.numero as remito_numero,v.numero_pedido,tv.nombre as tipo_venta_especial,tv.slug as venta_especial_slug,d.nombre as deposito_actual,
                                        ch_ci.id as check_control_interno_resultado_cabecera_id,ch_ci.firmado,cv.color as color_vehiculo,
                                        pat.dominio,current_date-fecha_emision_documento::date as dias_en_stock,age.fecha as fecha_entrega,age.hora as hora_entrega,encuesta.id as encuesta_alerta_temprana,
                                        (select id from danios_vehiculos_interno where vehiculo_id=v.id and solucionado=false limit 1) as danio_interno_sin_solucionar
					FROM     estados_vehiculos
					INNER JOIN (SELECT max(id) as lastId, vehiculo_id from estados_vehiculos group by vehiculo_id) eevv on estados_vehiculos.id =  eevv.lastId
					INNER JOIN vehiculos v ON estados_vehiculos.vehiculo_id = v.id
					INNER JOIN tipo_estado_vehiculo  ON estados_vehiculos.tipo_estado_vehiculo_id = tipo_estado_vehiculo.id
                                        INNER JOIN colores_vehiculos cv ON v.color_vehiculo_id=cv.id
                                        LEFT JOIN codigos_modelo cm ON v.codigo_modelo_id=cm.id
                                        LEFT JOIN nombres_modelo nm ON cm.nombre_modelo_id=nm.id
                                        LEFT JOIN remitos ON v.remito_id=remitos.id
                                        LEFT JOIN tipos_venta_especial tv ON v.tipo_venta_especial_id=tv.id
                                        
                                        LEFT JOIN (SELECT max(id) as lastIdMd, vehiculo_id from movimientos_depositos group by vehiculo_id) mmdd on v.id =  mmdd.vehiculo_id
                                        LEFT JOIN  movimientos_depositos md ON  mmdd.lastIdMd=md.id
                                        LEFT JOIN depositos d ON md.deposito_destino_id=d.id
                                        LEFT JOIN check_control_interno_resultado_cabeceras ch_ci ON v.id=ch_ci.vehiculo_id
                                        LEFT JOIN patentamientos pat ON v.patentamiento_id=pat.id
                                        LEFT JOIN agenda_entregas age ON v.id=age.vehiculo_id
                                        LEFT JOIN encuesta_resultados_cabeceras encuesta ON v.id=encuesta.vehiculo_id
                                        WHERE " . $where .
                " ORDER BY " . $order;

        $stmt = $db->prepare($query);
        $stmt->execute();

        return $stmt->fetchAll();
    }

    public function getVendidosPorVendedor($vendedor, $fechaDesde, $fechaHasta) {
        $db = $this->getEntityManager()->getConnection();
        $vendedorId = $vendedor->getId();
        $fechaDesde = $fechaDesde->format('Y-m-d') . ' 00:00:00';
        $fechaHasta = $fechaHasta->format('Y-m-d') . ' 23:59:59';
        $query = "SELECT
		     vehiculos.id AS id,
		     vehiculos.codigo_modelo_id AS codigo_modelo_id,
		     vehiculos.creado_por AS creado_por,
		     vehiculos.actualizado_por AS actualizado_por,
		     vehiculos.remito_id AS remito_id,
		     vehiculos.cliente_id AS cliente_id,
		     vehiculos.tipo_venta_especial_id AS tipo_venta_especial_id,
		     vehiculos.factura_id AS factura_id,
		     vehiculos.patentamiento_id AS patentamiento_id,
		     vehiculos.transportista_id AS transportista_id,
		     vehiculos.vin AS vin,
		     vehiculos.motor AS motor,
		     vehiculos.codigo_llave AS codigo_llave,
		     vehiculos.codigo_radio AS codigo_radio,
		     vehiculos.codigo_seguridad AS codigo_seguridad,
		     vehiculos.codigo_inmovilizador AS codigo_inmovilizador,
		     vehiculos.km_ingreso AS km_ingreso,
		     vehiculos.observacion AS observacion,
		     vehiculos.creado AS creado,
		     vehiculos.actualizado AS actualizado,
		     vehiculos.chasis AS chasis,
		     vehiculos.documento AS documento,
		     vehiculos.importe AS importe,
		     vehiculos.impuestos AS impuestos,
		     vehiculos.numero_pedido AS numero_pedido,
		     vehiculos.numero_orden AS numero_orden,
		     vehiculos.numero_grupo AS numero_grupo,
		     vehiculos.numero_solicitud AS numero_solicitud,
		     vehiculos.fecha_emision_documento AS fecha_emision_documento,
		     vehiculos.vendedor_id AS vendedor_id,
		     vehiculos.color_vehiculo_id AS color_vehiculo_id,
		     vehiculos.pagado AS pagado,
		     colores_vehiculos.color AS colores_vehiculos_color,
		     nombres_modelo.nombre||'|'||codigos_modelo.anio||'|'||codigos_modelo.codigo||'|'||codigos_modelo.version as modelo,
		     facturas.fecha AS facturas_fecha
		FROM
		     facturas facturas INNER JOIN vehiculos vehiculos ON facturas.id = vehiculos.factura_id
		     INNER JOIN colores_vehiculos colores_vehiculos ON vehiculos.color_vehiculo_id = colores_vehiculos.id
		     INNER JOIN codigos_modelo codigos_modelo ON vehiculos.codigo_modelo_id = codigos_modelo.id
		     INNER JOIN nombres_modelo nombres_modelo ON codigos_modelo.nombre_modelo_id = nombres_modelo.id
		WHERE
			 vehiculos.vendedor_id =$vendedorId
		     AND facturas.fecha BETWEEN '$fechaDesde' and '$fechaHasta'";

        $stmt = $db->prepare($query);
        $stmt->execute();

        return $stmt->fetchAll();
    }

    /*
     * devulve las entregas programadas en un rango de fechas
     */

    public function getAgendaEntregas($fechaDesde, $fechaHasta) {
        $db = $this->getEntityManager()->getConnection();
        $fechaDesde = $fechaDesde->format('Y-m-d') . ' 00:00:00';
        $fechaHasta = $fechaHasta->format('Y-m-d') . ' 23:59:59';
        $query = "SELECT v.*,
		     nombres_modelo.nombre||'|'||codigos_modelo.anio||'|'||codigos_modelo.codigo||'|'||codigos_modelo.version as modelo,
                     colores_vehiculos.color,a.fecha as fecha_entrega,a.hora as hora_entrega,a.hora,a.descripcion as descripcion_entrega,d.nombre as deposito_actual
		
                    FROM     estados_vehiculos
                    INNER JOIN (SELECT max(id) as lastId, vehiculo_id from estados_vehiculos group by vehiculo_id) eevv on estados_vehiculos.id =  eevv.lastId
                    INNER JOIN vehiculos v ON estados_vehiculos.vehiculo_id = v.id
                    INNER JOIN tipo_estado_vehiculo  ON estados_vehiculos.tipo_estado_vehiculo_id = tipo_estado_vehiculo.id

                    INNER JOIN agenda_entregas a ON a.vehiculo_id=v.id 
                    INNER JOIN colores_vehiculos colores_vehiculos ON v.color_vehiculo_id = colores_vehiculos.id
                    INNER JOIN codigos_modelo codigos_modelo ON v.codigo_modelo_id = codigos_modelo.id
                    INNER JOIN nombres_modelo nombres_modelo ON codigos_modelo.nombre_modelo_id = nombres_modelo.id
                    LEFT JOIN (SELECT max(id) as lastIdMd, vehiculo_id from movimientos_depositos group by vehiculo_id) mmdd ON v.id =  mmdd.vehiculo_id
                    LEFT JOIN  movimientos_depositos md ON  mmdd.lastIdMd=md.id
                    LEFT JOIN depositos d ON md.deposito_destino_id=d.id		     
		WHERE
                        tipo_estado_vehiculo.slug <> 'entregado' AND
		      a.fecha BETWEEN '$fechaDesde' and '$fechaHasta'";

        $stmt = $db->prepare($query);
        $stmt->execute();

        return $stmt->fetchAll();
    }

    public function getVehiculosEnStock($filters = null) {

        $where = "tipo_estado_vehiculo.slug in ('transito','recibido','stock') and (v.cliente_id is null or clientes.reventa=false)";
        $db = $this->getEntityManager()->getConnection();

        if ($filters['colorVehiculo']) {
            $where.=" AND v.color_vehiculo_id=" . $filters['colorVehiculo']->getId();
        }
//        if ($filters['tipoVentaEspecial']) {
//            $where.=" AND v.tipo_venta_especial_id=" . $filters['tipoVentaEspecial']->getId();
//        }
        if ($filters['deposito']) {
            $where.=" AND d.id=" . $filters['deposito']->getId();
        }
        if ($filters['modelo']) {
            $where.=" AND nm.id=" . $filters['modelo']->getId();
        }


        $query = "SELECT   distinct(v.*),
                                        nm.nombre||'|'||cm.anio||'|'||cm.codigo||'|'||cm.version as modelo,
                                        tipo_estado_vehiculo.estado as vehiculo_estado,tipo_estado_vehiculo.slug as vehiculo_estado_slug,remitos.fecha as remito_fecha,
                                        remitos.numero as remito_numero,v.numero_pedido,tv.nombre as tipo_venta_especial,tv.slug as venta_especial_slug,d.nombre as deposito_actual,
                                        cv.color as color_vehiculo,
                                        pat.dominio,current_date-fecha_emision_documento::date as dias_en_stock,age.fecha as fecha_entrega
					FROM     estados_vehiculos
					INNER JOIN (SELECT max(id) as lastId, vehiculo_id from estados_vehiculos group by vehiculo_id) eevv on estados_vehiculos.id =  eevv.lastId
					INNER JOIN vehiculos v ON estados_vehiculos.vehiculo_id = v.id
					INNER JOIN tipo_estado_vehiculo  ON estados_vehiculos.tipo_estado_vehiculo_id = tipo_estado_vehiculo.id
                                        INNER JOIN colores_vehiculos cv ON v.color_vehiculo_id=cv.id
                                        LEFT JOIN codigos_modelo cm ON v.codigo_modelo_id=cm.id
                                        LEFT JOIN nombres_modelo nm ON cm.nombre_modelo_id=nm.id
                                        LEFT JOIN remitos ON v.remito_id=remitos.id
                                        LEFT JOIN tipos_venta_especial tv ON v.tipo_venta_especial_id=tv.id
                                        
                                        LEFT JOIN (SELECT max(id) as lastIdMd, vehiculo_id from movimientos_depositos group by vehiculo_id) mmdd on v.id =  mmdd.vehiculo_id
                                        LEFT JOIN  movimientos_depositos md ON  mmdd.lastIdMd=md.id
                                        LEFT JOIN depositos d ON md.deposito_destino_id=d.id
                                        LEFT JOIN patentamientos pat ON v.patentamiento_id=pat.id
                                        LEFT JOIN agenda_entregas age ON v.id=age.vehiculo_id
                                        LEFT JOIN clientes ON v.cliente_id=clientes.id
                                        WHERE " . $where .
                " ORDER BY modelo,color_vehiculo asc";

        $stmt = $db->prepare($query);
        $stmt->execute();

        return $stmt->fetchAll();
    }

    
     public function getVehiculosCuponGarantia($filters = null) {

        $where = " v.factura_id is not null ";
        $db = $this->getEntityManager()->getConnection();

        if ($filters['conCupon']=='SI') {
            $where.=" AND v.cupon_garantia is not null";
        }else{
             $where.=" AND v.cupon_garantia is null";
        }           


        $query = "SELECT   distinct(v.*),
                                        nm.nombre||'|'||cm.anio||'|'||cm.codigo||'|'||cm.version as modelo,                                        
                                        tv.nombre as tipo_venta_especial,tv.slug as venta_especial_slug,
                                        cv.color as color_vehiculo                                        
					FROM     vehiculos v 					
                                        INNER JOIN colores_vehiculos cv ON v.color_vehiculo_id=cv.id
                                        LEFT JOIN codigos_modelo cm ON v.codigo_modelo_id=cm.id
                                        LEFT JOIN nombres_modelo nm ON cm.nombre_modelo_id=nm.id                                        
                                        LEFT JOIN tipos_venta_especial tv ON v.tipo_venta_especial_id=tv.id     
                                        WHERE " . $where .
                " ORDER BY modelo,color_vehiculo asc";

        $stmt = $db->prepare($query);
        $stmt->execute();

        return $stmt->fetchAll();
    }
}
