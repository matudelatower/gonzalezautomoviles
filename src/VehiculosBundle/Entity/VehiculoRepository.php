<?php

namespace VehiculosBundle\Entity;

/**
 * VehiculoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class VehiculoRepository extends \Doctrine\ORM\EntityRepository {

	public function getVehiculosEstado( $estado ) {

		$ids = array();

		foreach ( $estado as $item ) {
			$ids[] = $item->getId();
		}
		$idsEstado = implode( ',', $ids );


		$db    = $this->getEntityManager()->getConnection();
		$query = "SELECT   public.vehiculos.*
					FROM     estados_vehiculos
					INNER JOIN (SELECT max(id) as lastId, vehiculo_id from estados_vehiculos group by vehiculo_id) eevv on estados_vehiculos.id =  eevv.lastId
					INNER JOIN vehiculos  ON estados_vehiculos.vehiculo_id = vehiculos.id
					INNER JOIN tipo_estado_vehiculo  ON estados_vehiculos.tipo_estado_vehiculo_id = tipo_estado_vehiculo.id
				  where tipo_estado_vehiculo.id in ($idsEstado)";

		$stmt = $db->prepare( $query );
		$stmt->execute();

		return $stmt->fetchAll();
	}

}
